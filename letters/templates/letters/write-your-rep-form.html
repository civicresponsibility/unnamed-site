<style>
#letter-preview {
	margin: -1.5em 0 1em 0;
	border: 1px solid #363;
	border-radius: 6px;
	background-color: #FEFEFE;
	padding: 1em;
	font-weight: 300;
}
</style>

<h2>Write a letter</h2>

<div class="row">
	<div class="col-sm-7 col-md-6">
		<form id="write-letter-form" onsubmit="return false;">
			<input type="hidden" name="campaign" value="{{letters_campaign.id}}"/>

			<p style="margin-bottom: 1em">Let&rsquo;s find out who
				{% if letters_campaign.target_representatives and letters_campaign.target_senators %}
					represents you in Congress.
				{% elif letters_campaign.target_representatives %}
					your representative in Congress is.
				{% elif letters_campaign.target_senators %}
					your senators in Congress are.
				{% endif %}
			</p>

			<p>What is your mailing address where you vote?</p>

			<div class="form-group">
				{# <label for="lettersAddrAddress">Address  <span class="tip">(where you vote)</span></label> #}
				<input type="text" class="form-control" id="lettersAddrAddress" name="addrAddress" placeholder="123 Your Location St.">
			</div>
			<div class="row">
				<div class="col-sm-5 col-md-6">
				  <div class="form-group">
					{# <label for="lettersAddrCity">City</label> #}
					<input type="text" class="form-control" id="lettersAddrCity" name="addrCity" placeholder="Everytown">
				  </div>
				</div>
				<div class="col-sm-3 col-md-2">
				  <div class="form-group">
					{# <label for="lettersAddrState">State</label> #}
					<select class="form-control" id="lettersAddrState" name="addrState" size="1" style="padding-left: 2px; padding-right: 0;">
						<option></option>
						{% for state in state_abbrs %}<option>{{state}}</option>{% endfor %}
					</select>
				  </div>
				</div>
				<div class="col-sm-4">
				  <div class="form-group">
					{# <label for="lettersAddrZip">ZIP</label> #}
					<input type="text" class="form-control" id="lettersAddrZip" name="addrZip" placeholder="12345" maxlength="10">
				  </div>
				</div>
			</div>
			<button id="write-letter-find-reps" class="btn btn-primary" onclick="write_letter_find_reps()">Next &raquo;</button>

			<div id="letters-stage-two" style="display: none">

				<p id="letters-who-are-my-reps">Your will be writing a letter to <span></span>.</p>
				<p>Your legislators require that we provide your name, address, and the fields below with your message. Please complete the form:</p>

				<div class="form-group">
					<label for="lettersEmail">Email Address</label>
					<input type="email" class="form-control" id="lettersEmail" name="email" placeholder="email address">
				</div>
				<label for="namePrefix">Name</label>
				<div class="row">
					<div class="col-md-3 col-lg-2">
					  <div class="form-group">
						{# <label for="lettersNamePrefix">Title</label> #}
						<select class="form-control" id="lettersNamePrefix" name="namePrefix" style="padding-left: 2px; padding-right: 0;">
							{# filled in once we know possible options #}
						</select>
					  </div>
					</div>
					<div class="col-md-4 col-lg-5">
					  <div class="form-group">
						{# <label for="lettersNameFirst">First Name</label> #}
						<input type="text" class="form-control" id="lettersNameFirst" name="nameFirst" placeholder="first name">
					  </div>
					</div>
					<div class="col-md-5">
					  <div class="form-group">
						{# <label for="lettersNameLast">Last Name</label> #}
						<input type="text" class="form-control" id="lettersNameLast" name="nameLast" placeholder="last name">
					  </div>
					</div>
				</div>
				<div id="letter-phone-field" class="form-group">
					<label for="lettersPhone">Phone Number <span class="tip">(required by some congressional offices)</span></label>
					<input type="tel" class="form-control" id="lettersPhone" name="phone" placeholder="555-555-1234">
				</div>
				<div id="letter-additional-fields">
				</div>

				<button id="write-letter-submit" type="submit" class="btn btn-primary" onclick="write_letter_submit()">Send Letter</button>
			</div>

		</form>

	</div>
	<div class="col-sm-5 col-md-6">
		<div id="letter-preview">
			<p>Dear representative,</p>
			<p>Reptiles are the best pets ever, and turtles are cute. Please take action on this very important issue.</p>
			<p>Sincerely,</p>
			<p>[your name]
		</div>
	</div>
</div>			

<script>
function ajax_submit(options) {
	var old_success = options.success;
	options.success = function(res) {
		if (res.error) {
			// add .has-error to the indicated field
			var field = null;
			if (res.field) {
				field = $('form *[name="' + res.field + '"]');
				field.parent('.form-group').addClass("has-error");
			}

			// show error modal, then re-enable fields
			show_modal_error("Error", res.error, function() {
				if (options.fields) options.fields.prop('disabled', false);
				if (old_error) old_error();
				if (field) field.focus();
			})
			return;
		}

		if (options.fields) options.fields.prop('disabled', false);
		if (old_success) old_success(res);
	};

	var old_error = options.error;
	options.error = function(res) {
		show_modal_error("Error", "Something went wrong, sorry!", function() {
			if (options.fields) options.fields.prop('disabled', false);
			if (old_error) old_error();
		})
	};

	//

	$('.form-group').removeClass('has-error');
	if (options.fields) options.fields.prop('disabled', true);

	ajax_with_indicator(options);
}

function letters_init() {
	if (window.location.hash == "#demo") {
		$('#lettersAddrAddress').val('4604 Old Highway 91')
		$('#lettersAddrCity').val('Nephi')
		$('#lettersAddrState').val('UT')
		$('#lettersAddrZip').val('84648')
	}
}

function write_letter_find_reps() {
	ajax_submit({
		fields: $('#write-letter-form input, #write-letter-form select, #write-letter-form button'),
		url: "/letters/_ajax/find-reps",
		method: "POST",
		data: {
			campaign: {{letters_campaign.id}},
			addrAddress: $('#lettersAddrAddress').val(),
			addrCity: $('#lettersAddrCity').val(),
			addrState: $('#lettersAddrState').val(),
			addrZip: $('#lettersAddrZip').val()
		},
		success: function(res) {
			// disable address fields

				// can't mark a <select> as read-only? making it 'disabled' would exclude it from serializeArray().
			$('#lettersAddrAddress, #lettersAddrCity, #lettersAddrZip').prop('readonly', true);

			// prepare dynamic fields.

			$('#lettersNamePrefix').html('<option></option>'); // clear options, add an empty option
			res.votervoice.fields.prefix_options.forEach(function(item) {
				$('#lettersNamePrefix').append($("<option/>").text(item));
			})

			$('#letter-phone-field').hide();
			res.votervoice.fields.requiredUserFields.forEach(function(item) {
				if (item == "phone")
					$('#letter-phone-field').show();
			})

			$('#letter-additional-fields').html(''); // clear
			var qid = 0;
			function add_additional_field(question_type, question) {
				var n = $("<div class='form-group'><label></label><select class='form-control'/></div>");
				$('#letter-additional-fields').append(n);
				$('#letter-additional-fields').append($("<input type='hidden'/>")
					.attr('name', 'extra-' + qid + '-type')
					.val(question_type));
				$('#letter-additional-fields').append($("<input type='hidden'/>")
					.attr('name', 'extra-' + qid + '-id')
					.val(question.id));
				n.find('select').attr('id', 'letters-additional-field-' + qid);
				n.find('select').attr('name', 'extra-' + qid + '-value');
				n.find('label').attr('for', n.find('select').attr('id'));
				n.find('label').text(question.question);
				n.find('select').html('<option/>'); // empty option
				question.validAnswers.forEach(function(item) {
					n.find('select').append($("<option/>").text(item));
				})
				qid++;
			}
			res.votervoice.fields.sharedQuestions.forEach(function(item) {
				add_additional_field("shared", item);
			})
			res.votervoice.fields.requiredQuestions.forEach(function(item) {
				add_additional_field("required", item);
			})
			

			// show fields

			$('#write-letter-find-reps').hide();
			$('#letters-stage-two').slideDown();

			// update text

			var mocs = "";
			for (var i = 0; i < res.mocs.length; i++) {
				if (i > 0) {
					if (res.mocs.length > 2) mocs += ",";
					mocs += " ";
					if (i == res.mocs.length - 1) mocs += "and ";
				}
				mocs += res.mocs[i].name;
			}
			$('#letters-who-are-my-reps span').text(mocs);

			// focus
			$('#lettersEmail').focus();

		},
	});
}

function write_letter_submit() {
	// Valid. Submit! Collect all of the form fields.
	var form_params = $('#write-letter-form').serializeArray();
	var data = { };
	for (var i = 0; i < form_params.length; i++)
		data[form_params[i].name] = form_params[i].value;

	ajax_submit({
		fields: $('#write-letter-form input, #write-letter-form select, #write-letter-form button'),
		url: "/letters/_ajax/write-letter",
		method: "POST",
		data: data,
		success: function(res) {
		},
		error: function() {
		}
	});
}
</script>
