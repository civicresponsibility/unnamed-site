{% load itfsite_utils %}

<style>
#letter-preview {
	margin-bottom: 2em;
	border: 1px solid rgba(0,0,0, .75);
	background-color: #574;
	padding: 1em;
	color: white;
	font-weight: bold;
}

#letter-preview .boilerplate {
	color: #EEE;
	font-weight: normal;
}

@media screen and (min-width: 992px) {
	#letter-preview {
		margin-top: -1em;
		margin-left: 2em;
	}
}
</style>

<div>

<h2>Write a letter</h2>

<div id="write-letter-form-row" class="row">
	<div class="col-md-push-6 col-md-6">
		<p class="visible-xs">Please send a letter to Congress about this issue:</p>
		<div id="letter-preview">
			<p class="boilerplate">Dear {{letters_campaign.sample_honorific}},</p>
			{{letters_campaign.message_body|render_text:'TextFormat.Markdown'}}
			<p class="boilerplate">Sincerely,
			<br>[your name]</p>
		</div>
	</div>
	<div class="col-md-pull-6 col-md-6">
		<form id="write-letter-form" onsubmit="return false;">
			<input type="hidden" name="campaign" value="{{letters_campaign.id}}"/>
			<input type="hidden" name="via_campaign" value="{{campaign.id}}"/>
		    <input type="hidden" name="ref_code" value="{{request.GET.utm_campaign}}"/>

			<p style="margin-bottom: 1em">Let&rsquo;s find out who
				{% if letters_campaign.target_representatives and letters_campaign.target_senators %}
					represents you in Congress.
				{% elif letters_campaign.target_representatives %}
					your representative in Congress is.
				{% elif letters_campaign.target_senators %}
					your senators in Congress are.
				{% endif %}
			</p>

			<p>What is your mailing address where you vote?</p>

			<div class="form-group">
				{# <label for="lettersAddrAddress">Address  <span class="tip">(where you vote)</span></label> #}
				<input type="text" class="form-control" id="lettersAddrAddress" name="addrAddress" placeholder="123 Your Location St.">
			</div>
			<div class="row">
				<div class="col-sm-5 col-md-6">
				  <div class="form-group">
					{# <label for="lettersAddrCity">City</label> #}
					<input type="text" class="form-control" id="lettersAddrCity" name="addrCity" placeholder="Everytown">
				  </div>
				</div>
				<div class="col-sm-3 col-md-2">
				  <div class="form-group">
					{# <label for="lettersAddrState">State</label> #}
					<select class="form-control" id="lettersAddrState" name="addrState" size="1" style="padding-left: 2px; padding-right: 0;">
						<option></option>
						{% for state in state_abbrs %}<option>{{state}}</option>{% endfor %}
					</select>
				  </div>
				</div>
				<div class="col-sm-4">
				  <div class="form-group">
					{# <label for="lettersAddrZip">ZIP</label> #}
					<input type="text" class="form-control" id="lettersAddrZip" name="addrZip" placeholder="12345" maxlength="10">
				  </div>
				</div>
			</div>
			<button id="write-letter-find-reps" class="btn btn-primary" onclick="write_letter_find_reps()">Next &raquo;</button>

			<div id="letters-stage-two" style="display: none">

				<p id="letters-who-are-my-reps">Your will be writing a letter to <span></span>.</p>
				<p>Your legislators require that we provide your name, address, and the fields below with your message. Please complete the form:</p>

				<div class="form-group">
					<label for="lettersEmail">Email Address</label>
					<input type="email" class="form-control" id="lettersEmail" name="email" placeholder="email address">
				</div>
				<label for="namePrefix">Name</label>
				<div class="row">
					<div class="col-md-3 col-lg-2">
					  <div class="form-group">
						{# <label for="lettersNamePrefix">Title</label> #}
						<select class="form-control" id="lettersNamePrefix" name="namePrefix" style="padding-left: 2px; padding-right: 0;">
							{# filled in once we know possible options #}
						</select>
					  </div>
					</div>
					<div class="col-md-4 col-lg-5">
					  <div class="form-group">
						{# <label for="lettersNameFirst">First Name</label> #}
						<input type="text" class="form-control" id="lettersNameFirst" name="nameFirst" placeholder="first name">
					  </div>
					</div>
					<div class="col-md-5">
					  <div class="form-group">
						{# <label for="lettersNameLast">Last Name</label> #}
						<input type="text" class="form-control" id="lettersNameLast" name="nameLast" placeholder="last name">
					  </div>
					</div>
				</div>
				<div id="letter-phone-field" class="form-group">
					<label for="lettersPhone">Phone Number <span class="tip">(required by some congressional offices)</span></label>
					<input type="tel" class="form-control" id="lettersPhone" name="phone" placeholder="555-555-1234">
				</div>
				<div id="letter-additional-fields">
				</div>

				<div id="letter-vv-email-confirm-code" style="display: none">
					<p class="text-danger">We&rsquo;ve sent you an email. <strong>KEEP THIS PAGE OPEN.</strong> The email will contain a code to verify your email address. When you receive that code, type it in here and then continue:</p>
					<input type="hidden" name="vv-email-confirm-email">
					<input type="hidden" name="vv-email-confirm-verif-id">
					<div class="form-group">
						<label for="lettersVvEmailConfirmCode">Email verification code</label>
						<input type="text" class="form-control" id="lettersVvEmailConfirmCode" name="vv-email-confirm-verif-code" placeholder="1234">
					</div>
				</div>

				<button id="write-letter-submit" type="submit" class="btn btn-primary" onclick="write_letter_submit()">Send Letter</button>
			</div>

		</form>

	</div>
</div>

<div id="write-letter-submitted" class="hidden">
	<p>Thanks! Your letter to <span></span> will be sent.</p>
</div>

</div>

<script>
function ajax_submit(options) {
	var old_success = options.success;
	options.success = function(res) {
		if (res.error) {
			// add .has-error to the indicated field
			var field = null;
			if (res.field) {
				field = $('form *[name="' + res.field + '"]');
				field.parent('.form-group').addClass("has-error");
			}

			// show error modal, then re-enable fields
			show_modal_error("Error", res.error, function() {
				if (options.fields) options.fields.prop('disabled', false);
				if (old_error) old_error();
				if (field) field.focus();
			})
			return;
		}

		if (options.fields) options.fields.prop('disabled', false);
		if (old_success) old_success(res);
	};

	var old_error = options.error;
	options.error = function(res) {
		show_modal_error("Error", "Something went wrong, sorry!", function() {
			if (options.fields) options.fields.prop('disabled', false);
			if (old_error) old_error();
		})
	};

	//

	$('.form-group').removeClass('has-error');
	if (options.fields) options.fields.prop('disabled', true);

	ajax_with_indicator(options);
}

function letters_init() {
	if (the_page && the_page.letter_defaults && the_page.letter_defaults.profile) {
		$('#lettersAddrAddress').val(the_page.letter_defaults.profile.address.addrAddress)
		$('#lettersAddrCity').val(the_page.letter_defaults.profile.address.addrCity)
		$('#lettersAddrState').val(the_page.letter_defaults.profile.address.addrState)
		$('#lettersAddrZip').val(the_page.letter_defaults.profile.address.addrZip)
		$('#lettersEmail').val(the_page.letter_defaults.email)
		$('#lettersNamePrefix').attr('initial-value', the_page.letter_defaults.profile.name.namePrefix);
		$('#lettersNameFirst').val(the_page.letter_defaults.profile.name.nameFirst)
		$('#lettersNameLast').val(the_page.letter_defaults.profile.name.nameLast)
		$('#lettersPhone').val(the_page.letter_defaults.profile.name.phone)
	}

	if (window.location.hash == "#demo") {
		$('#lettersAddrAddress').val('4604 Old Highway 91')
		$('#lettersAddrCity').val('Nephi')
		$('#lettersAddrState').val('UT')
		$('#lettersAddrZip').val('84648')
		$('#lettersEmail').val('test+0@if.then.fund');
		$('#lettersNamePrefix').attr('initial-value', 'Ms.');
		$('#lettersNameFirst').val('Jane');
		$('#lettersNameLast').val('Doe');
	}
}

function getRandomInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }

function write_letter_find_reps() {
	ajax_submit({
		fields: $('#write-letter-form input, #write-letter-form select, #write-letter-form button'),
		url: "/letters/_ajax/find-reps",
		method: "POST",
		data: {
			campaign: {{letters_campaign.id}},
			addrAddress: $('#lettersAddrAddress').val(),
			addrCity: $('#lettersAddrCity').val(),
			addrState: $('#lettersAddrState').val(),
			addrZip: $('#lettersAddrZip').val()
		},
		success: function(res) {
			// disable address fields

				// can't mark a <select> as read-only? making it 'disabled' would exclude it from serializeArray().
			$('#lettersAddrAddress, #lettersAddrCity, #lettersAddrZip').prop('readonly', true);

			// prepare dynamic fields.

			$('#lettersNamePrefix').html('<option></option>'); // clear options, add an empty option
			res.votervoice.fields.prefix_options.forEach(function(item) {
				$('#lettersNamePrefix').append($("<option/>").text(item));
			})
			$('#lettersNamePrefix').val($('#lettersNamePrefix').attr('initial-value')); // set initial value from default

			$('#letter-phone-field').hide();
			res.votervoice.fields.requiredUserFields.forEach(function(item) {
				if (item == "phone")
					$('#letter-phone-field').show();
			})

			$('#letter-additional-fields').html(''); // clear
			var qid = 0;
			function add_additional_field(question_type, question) {
				var n = $("<div class='form-group'><label></label><select class='form-control'/></div>");
				$('#letter-additional-fields').append(n);
				$('#letter-additional-fields').append($("<input type='hidden'/>")
					.attr('name', 'extra-' + qid + '-type')
					.val(question_type));
				$('#letter-additional-fields').append($("<input type='hidden'/>")
					.attr('name', 'extra-' + qid + '-id')
					.val(question.id));
				n.find('select').attr('id', 'letters-additional-field-' + qid);
				n.find('select').attr('name', 'extra-' + qid + '-value');
				n.find('label').attr('for', n.find('select').attr('id'));
				n.find('label').text(question.question);
				n.find('select').html('<option/>'); // empty option
				question.validAnswers.forEach(function(item) {
					n.find('select').append($("<option/>").text(item));
				})
				qid++;

				if (window.location.hash == "#demo") {
					// For demonstrations, pre-select a random option.
					n.find('select').val(question.validAnswers[getRandomInt(0, question.validAnswers.length-1)]);
				}
			}
			res.votervoice.fields.sharedQuestions.forEach(function(item) {
				add_additional_field("shared", item);
			})
			res.votervoice.fields.requiredQuestions.forEach(function(item) {
				add_additional_field("required", item);
			})
			

			// show fields

			$('#write-letter-find-reps').hide();
			$('#letters-stage-two').slideDown();

			// update text

			var mocs = "";
			for (var i = 0; i < res.mocs.length; i++) {
				if (i > 0) {
					if (res.mocs.length > 2) mocs += ",";
					mocs += " ";
					if (i == res.mocs.length - 1) mocs += "and ";
				}
				mocs += res.mocs[i].name;
			}
			$('#letters-who-are-my-reps span').text(mocs);

			// focus
			$('#lettersEmail').focus();

		},
	});
}

function write_letter_submit() {
	// Valid. Submit! Collect all of the form fields.
	var form_params = $('#write-letter-form').serializeArray();
	var data = { };
	for (var i = 0; i < form_params.length; i++)
		data[form_params[i].name] = form_params[i].value;

	ajax_submit({
		fields: $('#write-letter-form input, #write-letter-form select, #write-letter-form button'),
		url: "/letters/_ajax/write-letter",
		method: "POST",
		data: data,
		success: function(res) {
			if (res.status == "already-wrote-a-letter") {
        		show_modal_error("Error", "It looks like you have already written a letter on this subject. Please reload the page to see it.");
        		$('#write-letter-form input, #write-letter-form select, #write-letter-form button').prop('disabled', true);
			} else if (res.status == "vv-verify-email") {
				// VoterVoice sent a verification email. Show the new form fields to
				// collect the verification code.
				$('#letter-vv-email-confirm-code').slideDown();
				$('#write-letter-form input[name="vv-email-confirm-email"]').val(res.for_email);
				$('#write-letter-form input[name="vv-email-confirm-verif-id"]').val(res.verificationId);
			} else if (res.status == "needs-password") {
				// Redirect to the welcome page.
				window.location = res.redirect;
			} else {
				// All good. Replace the form with letter info.
				$('#write-letter-form-row').slideUp(function() { $('#write-letter-form-row').remove(); })
				$('#write-letter-submitted').find('span').text(res.sent_to);
				$('#write-letter-submitted').removeClass('hidden');
			}
		},
		error: function() {
		}
	});
}
</script>
