<style>
#advanced-filters label div {
  margin-left: 1.5em;
  font-size: 85%;
}
  #pledge-party {
    margin-bottom: .25em;
  }
  #pledge-party .control-group {
    float: left;
    margin-right: 1em;
  }

#pledge-amount {
  max-width: 10em;
  border: 1px solid #AAA;
  margin: 1em 0;
}
  #pledge-amount .input-group-addon, #pledge-amount input {
    border: none;
    font-size: 24px;
    text-align: right;
  }

.input-table {
  margin-bottom: 1.5em;
}
  .input-table td {
    padding-right: .4em;
    padding-bottom: 2px;
  }
  .input-table td input {
  }

#make-pledge .buttons {
  margin-top: 1.5em;
}

.responsive-side-panel {
  font-size: 90%;
  color: #331;
}
@media screen and (min-width: 768px) {
  .responsive-side-panel {
    margin-left: 2em;
    border-left: 1px solid #775;
    padding: .5em 0 .5em 1em;
  }
}
@media screen and (max-width: 767px) {
  .responsive-side-panel {
    margin: 1em 0;
    border: 1px solid #775;
    padding: .5em;
  }
}
</style>

<div id="make-pledge">
  <form id="pledge-info" onsubmit="return false;">
    
    <input type="hidden" name="trigger" value="{{trigger.id}}"/>
    <input type="hidden" name="ref_code" value="{{request.GET.utm_campaign}}"/>
    <input type="hidden" name="via_campaign" value="{{campaign.id}}"/>
    <input type="hidden" name="algorithm" value="{{alg.id}}"/>
    <input type="hidden" name="desired_outcome" value="?"/>
    <input type="hidden" name="amount" value="?"/>
    <input type="hidden" name="incumb_challgr" value="?"/>
    <input type="hidden" name="filter_party" value=""/>
    <input type="hidden" name="billingCCExpMonth" value="?"/>
    <input type="hidden" name="billingCCExpYear" value="?"/>
    <input type="hidden" name="copyFromPledge" value=""/>
    <input type="hidden" name="tip_amount" value="0"/>

    <p style="margin: 2em 0">Your contribution &mdash; based on {% if not trigger.trigger_type.extra.monovalent %}how{% else %}which{% endif %} {{trigger.trigger_type.strings.actors}} actually {{trigger.verb}}{% if trigger.trigger_type.extra.monovalent %} {{trigger.outcomes.0.object}}{% endif %} &mdash; will shape the next Congress.</p>

    <div>
      <div>
        <div id="pledge-start">
          <h2>Amount</h2>

          <div id="pledge-amount" class="input-group">
            <div class="input-group-addon">$</div>
            <input id="pledge-amount-field" class="form-control focus-on-shown" type="text" value="{{suggested_pledge|floatformat:2}}" pattern="^([0-9]+(,[0-9]{3})*)?(\.[0-9]{0,2})?$" onkeyup="contribution_start_validation()" onchange="contribution_start_validation()" title="Contribution">
          </div>

          <div id="advanced-filters" style="display: none" class="panel panel-default">
            <div class="panel-heading">Who gets your contribution?</div>
            <div class="panel-body">

            {% if not trigger.trigger_type.extra.monovalent %}
            <div> {# scopes the text-danger #}
              {% if tcust.incumb_challgr != -1 %}
              <div class="control-group">
                <p style="margin-bottom: 0"><strong>Keep &rsquo;em in.</strong></p>
                <label for="filterIncumbents">
                  <input id="filterIncumbents" type="checkbox" onchange="contribution_start_validation()"
                    {% if tcust.incumb_challgr != -1 %}checked{% endif %}
                    {% if tcust.incumb_challgr %}disabled class="hidden"{% endif %}>
                  If a {{trigger.trigger_type.strings.actor}} {{trigger.verb_pres_s}} <span class="fill-in"> </span>, then fund their reelection campaign.
                </label>
              </div>
              {% endif %}

              {% if tcust.incumb_challgr != 1 %}
              <div class="control-group">
                <p style="margin-bottom: 0"><strong>Throw &rsquo;em out.</strong></p>
                <label for="filterChallengers">
                  <input id="filterChallengers" type="checkbox" onchange="contribution_start_validation()"
                    {% if tcust.incumb_challgr != 1 %}checked{% endif %}
                    {% if tcust.incumb_challgr %}disabled class="hidden"{% endif %}>
                  If a {{trigger.trigger_type.strings.actor}} {{trigger.verb_pres_s}} <span class="fill-in"> </span>, then fund their opponent&rsquo;s campaign.
                </label>
              </div>
              {% endif %}

              <p class="text-danger" style="display: none">You must choose at least one.</p>
            </div>
            {% endif %}

            <p style="margin-bottom: 0"><strong>Only make contributions to:</strong></p>

            <div id="pledge-party">
              {% if tcust.filter_party|stringformat:'s' != 'ActorParty.Democratic' %}
              <div class="control-group">
                <label for="filterPartyR" data-value="R">
                  <input  id="filterPartyR" type="checkbox" onchange="contribution_start_validation()"
                    {% if tcust.filter_party|stringformat:'s' != 'ActorParty.Democratic' %}checked{% endif %}
                    {% if tcust.filter_party %}disabled class="hidden"{% endif %}>
                  Republicans
                </label>
              </div>
              {% endif %}

              {% if tcust.filter_party|stringformat:'s' != 'ActorParty.Republican' %}
              <div class="control-group">
                <label for="filterPartyD" data-value="D">
                  <input id="filterPartyD" type="checkbox" onchange="contribution_start_validation()"
                    {% if tcust.filter_party|stringformat:'s' != 'ActorParty.Republican' %}checked{% endif %}
                    {% if tcust.filter_party %}disabled class="hidden"{% endif %}>
                  Democrats
                </label>
              </div>
              {% endif %}

              <div class="clearfix"> </div>

              <p class="text-danger" style="display: none">You must choose at least one.</p>
            </div>

            {% if tcust.incumb_challgr or tcust.filter_party %}
            <p style="margin-bottom: 0; font-style: italic; font-size: 88%; color: #666;">Some of these options have been pre-set by {{tcust.owner.name}}.</p>
            {% endif %}
          </div> <!-- /panel-body -->
          </div> <!-- /advnaced-filters -->

          <p id="filter-summary">
            <span class="text"> </span>

            {# see #advanced-filters-toggle #}
            {% if tcust.incumb_challgr and tcust.filter_party %}
              {# no need to show the advanced options panel if there is nothing to customize #}
              <span style="font-style: italic;">(This has been preset by {{tcust.owner.name}}.)</span>
            {% endif %}
          </p>

          <div class="buttons">
            {# see #filter-summary #}
            {% if not tcust.incumb_challgr or not tcust.filter_party %}
              <button id="advanced-filters-toggle" type="button" class="btn btn-default" onclick="return show_and_scroll('advanced-filters', this);">Advanced Filters</button>
            {% endif %}

            <button id="contribution-start-next" type="button" class="btn btn-warning" onclick="do_pledge_start_next()">Next &gt;</button
            >
          </div>
        </div> <!-- /pledge-start -->

        <div id="pledge-contributor" style="display: none">
          <h2>About you</h2>

          <div class="row">
            <div class="col-sm-5 col-sm-push-7 col-md-6 col-md-push-6">
              <div class="responsive-side-panel">
                  <p><strong>Federal law restricts who can make campaign contributions:</strong></p>
                  <p>You must be either a U.S. citizen or lawfully admitted permanent resident (i.e., a green card holder). You cannot be employed <i>directly</i> by the federal government as a contractor. You must make this contribution with your own funds, which were not provided to you by any other person or entity. You must use your own personal credit card, and not a corporate or business card or a card issued to another person.</p>
                  <p><strong>and requires us to collect and share information about you.</strong></p>
                  <p>The Federal Election Commission requires all contributors to federal campaigns to provide all of the information we ask for in this section, and {% if trigger.status|stringformat:'s' != 'TriggerStatus.Executed' %}if {{trigger.trigger_type.strings.prospective_vp}} {% endif %}in most cases it becomes a part of the public record and searchable in online databases (<a href="/about/how-it-works#isthisanonymous" target="_blank">more information</a>).</p>
              </div>
            </div>
            <div class="col-sm-7 col-sm-pull-5 col-md-6 col-md-pull-6">
              <div id="contributor-new">
                <div id="pledge-email-name-and-address-new">
                <div id="contributor-email" class="form-group">
                  <label for="email">Email Address</label>
                  <input type="email" class="form-control" id="emailEmail" name="email" placeholder="yourname@youremail.com" onblur="do_pledge_validate_email()">

                  <div id="pledge-login">
                    <div style="margin-top: 2px; margin-left: 2px;">
                      <label for="emailEmailYesPassword" style="font-size: 80%">
                        <input id="emailEmailYesPassword" type="checkbox" name="hasPassword" onchange="$('#emailPasswordDiv').toggle($(this).prop('checked')); setTimeout('$(&quot;#emailPassword&quot;).focus()', 1)">
                        I have an account already.
                      </label>
                    </div>
                    <div id="emailPasswordDiv" style="display: none; margin-left: 1em">
                      <div class="form-group form-inline">
                        <label for="emailPassword">Password:</label>
                        <input type="password" id="emailPassword" class="form-control" style="max-width: 15em">
                        <button id="login-next" type="button" class="btn btn-primary" onclick="do_pledge_login()">Login &gt;</button>
                      </div>
                      <div class="small" style="margin-top: 2px">Forgot your password? Uncheck the box above and continue.</div>
                      <p id="login-error" class="text-danger" style="display: none; padding-top: 1em"></p>
                    </div> <!-- /emailPasswordDiv -->
                  </div> <!-- /pledge-login -->
                </div> <!-- contributor-email -->

                <label>Name and Address</label>
                <div class="row">
                  <div class="col-sm-6">
                    <div class="form-group">
                      {# <label for="contribNameFirst">First Name</label> #}
                      <input type="text" class="form-control" id="contribNameFirst" name="contribNameFirst" placeholder="first name">
                    </div>
                  </div>
                  <div class="col-sm-6">
                    <div class="form-group">
                      {# <label for="contribNameLast">Last Name</label> #}
                      <input type="text" class="form-control" id="contribNameLast" name="contribNameLast" placeholder="last name">
                    </div>
                  </div>
                </div>
                <div class="form-group">
                  {# <label for="contribAddress">Address</label> #}
                  <input type="text" class="form-control" id="contribAddress" name="contribAddress" placeholder="123 Your Location St.">
                </div>
                <div class="row">
                  <div class="col-sm-5 col-md-6">
                    <div class="form-group">
                      {# <label for="contribCity">City</label> #}
                      <input type="text" class="form-control" id="contribCity" name="contribCity" placeholder="Everytown">
                    </div>
                  </div>
                  <div class="col-sm-3 col-md-2">
                    <div class="form-group">
                      {# <label for="contribState">State</label> #}
                      <input type="text" class="form-control" id="contribState" name="contribState" placeholder="state">
                    </div>
                  </div>
                  <div class="col-sm-4">
                    <div class="form-group">
                      {# <label for="contribZip">ZIP</label> #}
                      <input type="text" class="form-control" id="contribZip" name="contribZip" placeholder="12345" maxlength="10">
                    </div>
                  </div>
                </div>
                </div> <!-- /pledge-email-name-and-address-new -->

                <div id="pledge-email-name-and-address-old" style="display: none">
                  <p>We&rsquo;ve got your name and address, but federal law requires that we collect some additional information.</p>

                  <p style="margin: 1em 2em .5em 2em">
                    <span class="field-contribNameFirst"> </span> <span class="field-contribNameLast"> </span>
                    <br><span class="field-contribAddress"> </span>
                    <br><span class="field-contribCity"> </span>, <span class="field-contribState"> </span> <span class="field-contribZip"> </span>
                  </p>
                  <p class="contributor-existing-email" style="margin: .25em 2em .5em 2em">
                    <span class="field-emailEmail"> </span>
                  </p>

                  <p style="margin: .5em 2em 1.5em 2em">
                    <button id="pledge-email-name-and-address-old-update" href="#" class="btn btn-default btn-sm" onclick="$('#pledge-email-name-and-address-old').hide(); $('#pledge-email-name-and-address-new').show(); $('#contributor-new .focus-on-shown').focus(); return false;">Update</button>
                  </p>
                </div> <!-- /pledge-email-name-and-address-old -->

                <div class="row">
                  <div class="col-xs-12">
                    <div>
                      <label for="contribUnemployed">
                        <input id="contribUnemployed" type="checkbox" onchange="$('.contribUnemployedTarget').toggle(!$(this).prop('checked')); if ($(this).prop('checked')) { $('#contribOccupation').val('not employed'); $('#contribEmployer').val('none'); }">
                        Retired or not employed?
                      </label>
                    </div>
                    <div class="col-sm-6 contribUnemployedTarget">
                      <div class="form-group">
                        <label for="contribOccupation">Occupation</label>
                        <input type="text" class="form-control" id="contribOccupation" name="contribOccupation">
                      </div>
                    </div>
                    <div class="col-sm-6 contribUnemployedTarget">
                      <div class="form-group">
                        <label for="contribEmployer">Employer</label>
                        <input type="text" class="form-control" id="contribEmployer" name="contribEmployer">
                      </div>
                    </div>
                  </div>
                </div>

                <p class="has-open-pledges" style="display: none;">We&rsquo;ll apply your update to your other scheduled contributions too.</p>
              </div> <!-- contributor-new -->


              <div id="contributor-old" style="display: none">
                <p>Please check your name, address, and employment. Is what you told us last time still true?</p>

                <p style="margin: 1em 2em .25em 2em">
                  <span class="field-contribNameFirst"> </span> <span class="field-contribNameLast"> </span>
                  <br><span class="field-contribAddress"> </span>
                  <br><span class="field-contribCity"> </span>, <span class="field-contribState"> </span> <span class="field-contribZip"> </span>
                </p>
                <p class="contributor-existing-email" style="margin: .25em 2em .5em 2em">
                  <span class="field-emailEmail"> </span>
                </p>
                <p style="margin: .25em 2em .5em 2em">
                  <span class="field-contribOccupation"> </span> <span style="font-size: 95%; font-style: italic">(occupation)</span>
                  <br><span class="field-contribEmployer"> </span> <span style="font-size: 95%; font-style: italic">(employer)</span>
                </p>

                <p style="margin: .5em 2em 1.5em 2em">
                  <button id="pledge-contributor-old-update" href="#" class="btn btn-default btn-sm" onclick="$('#pledge-info input[name=&quot;copyFromPledge&quot;]').val(''); $('#contributor-old, #payment-old').hide(); $('#contributor-new, #payment-new').show(); $('#contributor-new .focus-on-shown').focus(); return false;">Update</button>
                </p>
              </div> <!-- contributor-old -->

              <p>This information may become a part of the public record{% if trigger.status|stringformat:'s' != 'TriggerStatus.Executed' %} if {{trigger.trigger_type.strings.prospective_vp}}{% endif %}, as required by law.</p>

              <div class="buttons">
                <button type="button" class="btn btn-default" onclick="do_contributor_cancel();">&lt; Back</button>        
                <button id="contribution-contributorinfo-next" type="button" class="btn btn-warning" onclick="do_contributor_next()">Next &gt;</button>
              </div>
            </div> <!-- /col -->
          </div> <!-- /row -->
        </div> <!-- /pledge-contributor -->

        <div id="pledge-payment" style="display: none">
          <h2>Payment information</h2>

          <div class="row">
            <div class="col-sm-7 col-md-6">
              <div id="payment-new">
              <p>Enter the credit card information that you would like us to charge{% if trigger.status|stringformat:'s' != 'TriggerStatus.Executed' %} when {{trigger.trigger_type.strings.prospective_vp}}{% endif %}.</p>

              <table class="input-table">
                <tr>
                  <td><label for="billingCCNum">Number</label></td>
                  <td>
                    <input type="text" class="cc-num focus-on-shown form-control" id="billingCCNum" name="billingCCNum" pattern="\d*" novalidate autocomplete="cc-number" placeholder="0000 0000 0000 0000" required>
                  </td>
                </tr>
                <tr>
                  <td><label for="billingCCExp">Expiration</label></td>
                  <td>
                    <input type="text" class="cc-exp form-control" id="billingCCExp" pattern="\d+/\d+" novalidate placeholder="MM/YYYY">
                  </td>
                </tr>
                <tr>
                  <td><label for="billingCCCVC">CVC</label></td>
                  <td>
                    <input type="text" class="cc-cvc form-control" id="billingCCCVC" name="billingCCCVC" autocomplete="off">
                  </td>
                </tr>
              </table>
              <p class="has-open-pledges" style="display: none; margin-bottom: 1.5em;">We&rsquo;ll apply this payment information to your other scheduled contributions too.</p>
              </div> <!-- /payment-new -->

              <div id="payment-old" style="display: none">
                <p>{% if trigger.status|stringformat:'s' != 'TriggerStatus.Executed' %}When {{trigger.trigger_type.strings.prospective_vp}} w{% else %}W{% endif %}e&rsquo;ll charge your credit card ending in <span class="cc-num"></span>.
                  <a href="#" onclick="$('#pledge-info input[name=&quot;copyFromPledge&quot;]').val(''); $('#payment-old').hide(); $('#payment-new').show(); $('#payment-new .focus-on-shown').focus(); return false;">Change card?</a>
                </p>
              </div> <!-- /payment-old -->

              {% if campaign.owner.de_recip_id %}
                <p>
                  <label for="contribTipOrg">
                    <input id="contribTipOrg" type="checkbox" name="contribTipOrg">
                    Add a $<span id="contribTipOrgAmt">___</span> donation to {{campaign.owner.name}}
                  </label>
                </p>
              {% endif %}

              <p style="margin: 1.5em 0">By clicking next, you agree that you have reviewed the contributor requirements above and our <a href="/terms" target="_blank">terms of use</a>.</p>

              <div id="pledge-submit-buttons" class="buttons" style="margin: 1.5em 0">
                <button type="button" class="btn btn-default" onclick="pledge_payment_cancel()">&lt; Back</button>
                <button id="billing-next" type="button" class="btn btn-warning" onclick="pledge_submit()">Confirm</button>
              </div>
            </div>
            <div class="col-sm-5 col-md-6">
              <div class="responsive-side-panel">
                  <p><strong>What happens next...</strong></p>
                  {% if trigger.status|stringformat:'s' != 'TriggerStatus.Executed' %}<p>You are about to schedule a campaign contribution for if and when {{trigger.trigger_type.strings.prospective_vp}}. You can cancel this contribution any time before then.</p>{% endif %} 
                  <p>Your contribution {% if trigger.status|stringformat:'s' != 'TriggerStatus.Executed' %}may{% else %}will{% endif %} be split up to {{trigger.max_split}} ways depending on {% if not trigger.trigger_type.extra.monovalent %}how{% else %}which{% endif %} {{trigger.trigger_type.strings.actors}} {% if trigger.status|stringformat:'s' != 'TriggerStatus.Executed' %}{{trigger.trigger_type.strings.action_vb_inf}}{% else %}{{trigger.trigger_type.strings.action_vb_past}}{% endif %}{% if trigger.trigger_type.extra.monovalent %} {{trigger.outcomes.0.object}}{% endif %}.</p>
                  <p>You may see a temporary $1 authorization from Democracy Engine, LLC on your credit card, which was our check that your credit card information is valid.</p>
              </div>
            </div>
          </div>
        </div> <!-- /pledge-payment -->

      </div> <!-- nothing -->
    </div> <!-- nothing -->
  </form>

</div> <!-- /make-pledge -->

<div id="completed-pledge-holder">
</div>
      
    
<script>
var _pledge_init_done = false;
function pledge_init() {
  if (_pledge_init_done) return;
  _pledge_init_done= true;

  // Don't let the user try to log in if they are logged in already.
  if (the_user) {
    $('#contributor-email, .contributor-existing-email').remove();
  }

  // Set some defaults based on the user's last pledge.
  if (the_page && the_page.pledge_defaults) {
    // First set defaults for the fields that are displayed prior to the option to login.

    if (the_page.pledge_defaults['amount']) {
      $('#pledge-amount input').val(the_page.pledge_defaults['amount'].toFixed(2));
    }

    {% if not tcust.incumb_challgr %}
    if (the_page.pledge_defaults.incumb_challgr) {
      $('#filterIncumbents, #filterChallengers').prop('checked', false);
      if (the_page.pledge_defaults.incumb_challgr == -1)
        $('#filterChallengers').prop('checked', true);
      else if (the_page.pledge_defaults.incumb_challgr == 1)
        $('#filterIncumbents').prop('checked', true);
      else if (the_page.pledge_defaults.incumb_challgr == 0)
        $('#filterIncumbents, #filterChallengers').prop('checked', true);
    }
    {% endif %}

    {% if not tcust.filter_party %}
    $('#filterPartyR').prop('checked', the_page.pledge_defaults.filter_party == 'ActorParty.Republican' || the_page.pledge_defaults.filter_party == null);
    $('#filterPartyD').prop('checked', the_page.pledge_defaults.filter_party == 'ActorParty.Democratic' || the_page.pledge_defaults.filter_party == null);
    {% endif %}

    if (the_page.pledge_defaults.email) {
        $('#emailEmail').val(the_page.pledge_defaults.email);
        $('#contributor-old .field-email').text(the_page.pledge_defaults.email);
    }

    // Set defaults for the other post-login tabs.
    setPledgeDefaults(the_page.pledge_defaults)
  }

  // Set up dynamic validation event handlers.

  $('input.cc-num').payment('formatCardNumber');
  $('input.cc-exp').payment('formatCardExpiry');
  $('input.cc-cvc').payment('formatCardCVC');

  // For testing, pre-fill form fields with demonstration values.

  if (window.location.hash == "#demo") {
    $('#emailEmail').val("demo+" + parseInt(1000+Math.random()*5000) + "@{{SITE_DOMAIN}}")
    $('#contribNameFirst').val('John')
    $('#contribNameLast').val('Doe')
    $('#contribAddress').val('123 Main Street')
    $('#contribCity').val('Plainview')
    $('#contribState').val('TX')
    $('#contribZip').val('00001-1234')
    $('#contribOccupation').val('demonstrator')
    $('#contribEmployer').val('self')
  }
  if (window.location.hash == "#demo" {% if SITE_MODE == "demo" %} || 1{% endif %}) {
    $('#billingCCNum').val('4111111111111111')
    $('#billingCCExp').val('1/2020')
    $('#billingCCCVC').val('000')
  }

  contribution_start_validation();
}

function setPledgeDefaults(pledge_defaults) {
  // pre-populate contributor fields
  var fields = ['emailEmail', 'contribNameFirst', 'contribNameLast', 'contribAddress', 'contribCity', 'contribState', 'contribZip', 'contribOccupation', 'contribEmployer'];
  var has_field = { };
  for (var i = 0; i < fields.length; i++) {
    var v = pledge_defaults[fields[i]];
    if (v) {
      // the span for the we've-already-got-it preview
      $('#contributor-old, #pledge-email-name-and-address-old').find('.field-' + fields[i]).text(v);

      // the input field (which is what is actually submitted)
      $('#' + fields[i]).val(v)

      // Remember that we have it.
      has_field[[fields[i]]] = true;
    }
  }

  if (!pledge_defaults.from_pledge) {
    // We've prefilled, but it's partial information --- no billing information.

    if (has_field.emailEmail && has_field.contribNameFirst && has_field.contribNameLast 
      && has_field.contribAddress && has_field.contribCity && has_field.contribState && has_field.contribZip) {
      // If we have email, name, and address fields, we can hide the input fields.
      // They're filled in -- they're what gets submitted. Just hidden.
      $('#pledge-email-name-and-address-new').hide();
      $('#pledge-email-name-and-address-old').show();
    
    } else {
      $('#pledge-email-name-and-address-new').show();
      $('#pledge-email-name-and-address-old').hide();
    }

    $('#contributor-new, #payment-new').show();
    $('#contributor-old, #payment-old').hide();

    return;
  }

  // populate credit card preview field
  $('#payment-old .cc-num').text(pledge_defaults.cclastfour);

  // if the user doesn't override, the ID of the pledge this info came from
  $('#pledge-info input[name="copyFromPledge"]').val(pledge_defaults.from_pledge);

  // show the preview divs rather than the input field divs
  $('#contributor-new, #payment-new').hide();
  $('#contributor-old, #payment-old').show();
  if (pledge_defaults.open_pledges > 0) $('.has-open-pledges').show()
}

function pledge_begin(outcome_index) {
	// Set form field for submission.
	$('#pledge-info input[name="desired_outcome"]').val(outcome_index)

	// Track event.
	mixpanel.track("Pledge Begin", {
    'outcome_index': outcome_index,
    'suggested_pledge': get_contribution_amount() // suggested_pledge or last contribution amount
  });

	// Prepare form.
	contribution_start_validation();
}

function get_contribution_amount() {
  // Check that the number input looks numeric in its entirety. parseFloat
  // ignores non-parsable content at the end. English localization is
  // hard-coded in the regular expression and in the handling of commas.
  var amt = $('#pledge-amount input').val();
  var re = RegExp($('#pledge-amount input').attr('pattern'))
  if (!re.test(amt)) return null;

  // Strip thousands-commas, which parseFloat doesn't like.
  amt = amt.replace(/,/, '');

  // Attempt to parse. parseFloat returns NaN if the expression cannot
  // be parsed. To be sure we'll also check that it doesn't return +/-Inf
  // (all three conditions are handled by isFinite).
  amt = parseFloat(amt);
  if (!isFinite(amt)) return null;

  // Round it to a whole number of cents.
  amt = Math.round(amt*100)/100;

  // Check bounds.
  if (amt < {{trigger.get_minimum_pledge}} || amt > {{alg.max_contrib}})
    return null;

  return amt;
}

function getIncumbentChallengerValue() {
  {% if trigger.trigger_type.extra.monovalent %}
  // With a monovalent trigger, Actors only ever take outcome zero.
  // The incumbent/challenger filter doesn't make sense because for
  // each desired outcome, only one filter is possible. i.e. It's
  // not possible to have desired outcome 0 and also contribute only
  // to challengers, because no actor will have an action with an
  // outcome other than zero.
  return 0;
  {% endif %}

  if ($('#filterIncumbents').prop('checked') && $('#filterChallengers').prop('checked'))
    return 0;
  if ($('#filterIncumbents').prop('checked'))
    return 1;
  if ($('#filterChallengers').prop('checked'))
    return -1;
  return null;
}

function getPartyFilterValue() {
  var party = "";
  $('#pledge-party input:checked').each(function(node) {
    party += $(this).parent().attr("data-value");
  })
  return party;
}
  
function validate_contribution_filters(no_popover) {
  // Validate that the user has selected either incumbents, challengers, or both (but not neither).
  if (getIncumbentChallengerValue() == null) {
    if (!no_popover)
      $('#filterIncumbents').parents('.control-group').parent().find('.text-danger').slideDown();
    return false;
  } else {
      $('#filterIncumbents').parents('.control-group').parent().find('.text-danger').slideUp();
  }

  // Validate that the user has selected Democrats, Republicans, or both (but not neither).
  if (getPartyFilterValue() == "") {
    if (!no_popover)
      $('#filterPartyR').parents('.control-group').parent().find('.text-danger').slideDown();
    return false;
  } else {
      $('#filterPartyR').parents('.control-group').parent().find('.text-danger').slideUp();
  }

  // What is the user's desired outcome?
  var outcome_index = $('#pledge-info input[name="desired_outcome"]').val();

  // This block isn't relevant right now.
  if (outcome_index == "?") {
    $('#filter-summary span.text').text("We will split your contribution across {% if trigger.status|stringformat:'s' != 'TriggerStatus.Executed' %}up to {% endif %}{{trigger.max_split}} {{trigger.trigger_type.strings.actors|escapejs}}.");
    $('#advanced-filters-toggle').prop('disabled', true);
    return false;
  }
  $('#advanced-filters-toggle').prop('disabled', false);

  // The incumbent/challenger choice labels include text specific for the trigger.
  // Fill in that text.
  var trigger_outcomes = [
    {% for outcome in all_outcome_strings %}
      "{% if outcome.object %}{{outcome.object|escapejs}}{% else %}{{outcome.label|escapejs}}{% endif %}"{% if not forloop.last %}, {% endif %}
    {% endfor %}
  ];
  var desired_action_text = trigger_outcomes[outcome_index];
  var opposed_action_text = trigger_outcomes[1-outcome_index];
  $('#filterIncumbents').parent().find('.fill-in').text(desired_action_text);
  $('#filterChallengers').parent().find('.fill-in').text(opposed_action_text);

  // Construct a human-readable explanation of the current filter choices.
  // This is mirrored in models.py's Pledge.targets_summary().
  var party = "";
  var anti_party = "";
  var pf = getPartyFilterValue();
  if (pf == "D") { party = "Democratic "; anti_party = "Republican "; }
  if (pf == "R") { party = "Republican "; anti_party = "Democratic "; }

  var ic = getIncumbentChallengerValue();

  // If the Trigger has already been executed, then count up the actual
  // total number of recipients that match the filters.
  var recip_counts = {{trigger_recips|safe}};
  var total_incumbent_recip = undefined;
  var total_challenger_recip = undefined;
  if (recip_counts) {
    total_incumbent_recip = 0;
    total_challenger_recip = 0;
    recip_counts = recip_counts[outcome_index];
    for (var i = 0; i < recip_counts.length; i++) {
      var c = recip_counts[i];
      if (ic != 0 && ic != c.incumbent) continue;
      if (pf.length == 1 && c.party != pf) continue;
      if (c.incumbent == 1)
        total_incumbent_recip += c.count;
      else
        total_challenger_recip += c.count;
    }
  }
  {% if trigger.trigger_type.extra.monovalent %}
  else {
    // With monovalent triggers, we know that there are definitely
    // no recipients in certain cases even if the Trigger is not yet
    // executed.
    if (outcome_index == 0) total_challenger_recip = 0;
    if (outcome_index  > 0) total_incumbent_recip = 0;
  }
  {% endif %}

  var who;
  if (ic == 0 && party == "" && !recip_counts && {% if not trigger.trigger_type.extra.monovalent %}1{% else %}0{% endif %})
    // This is the really simple case when there are no filters, no known counts of recipients, and the trigger is not monovalent.
    who = "{% if trigger.status|stringformat:'s' != 'TriggerStatus.Executed' %}up to {% endif %}{{trigger.max_split}} {{trigger.trigger_type.strings.actors|escapejs}}. Each will get a part of your contribution if they {{trigger.verb|escapejs}} " + desired_action_text + ". But if they {{trigger.verb|escapejs}} " + opposed_action_text + ", their part of your contribution will go to their next general election opponent"
  else {
    function number(n) {
      if (typeof n == "undefined")
        return "";
      if (n == 0)
        return "no ";
      return "the " + n + " ";
    }
    var who1 = number(total_incumbent_recip) + party + "{{trigger.trigger_type.strings.actors|escapejs}} who {{trigger.verb|escapejs}} " + desired_action_text;
    var who2 = number(total_challenger_recip) + party + "opponents in the next general election of " + anti_party + "{{trigger.trigger_type.strings.actors|escapejs}} who {{trigger.verb|escapejs}} " + opposed_action_text;
    var who2b = number(total_challenger_recip) + anti_party + "{{trigger.trigger_type.strings.actors|escapejs}} who {{trigger.verb|escapejs}} " + opposed_action_text + " (and therefore no " + party + "opponents to which to make a contribution)";

    if ((total_challenger_recip == 0 || ic == 1) && total_incumbent_recip != 0)
      // no challengers (either by filter or because we know the totals)
      // but there are (or might be) incumbents
      who = who1;
    else if ((total_incumbent_recip == 0 || ic == -1) && total_challenger_recip != 0)
      // no incumbents (either by filter or because we know the totals)
      // but there are (or might be) challengers
      who = who2;
    else if (total_incumbent_recip != 0 && total_challenger_recip != 0)
      // there are incumbents and challenger (in either case, it's either that
      // we don't know how many or we know and it's not zero)
      who = who1 + " and " + who2;
    else {
      // we know there are no recipients
      {% if not trigger.trigger_type.extra.monovalent %}
      var whos = [who1, who2b];
      {% else %}
      var whos = [outcome_index == 0 ? who1 : who2b];
      {% endif %}

      $('#filter-summary span.text').text("There were " + whos.join(" and ") + ". Please remove some of your filters as there is nobody to which to make a contribution given your preferences.");
      $('#filter-summary span.text').addClass("text-danger");
      $('#advanced-filters-toggle').click(); // ensure the panel is showing
      return false;
    }
  }

  $('#filter-summary span.text').removeClass("text-danger");
  $('#filter-summary span.text').text("We will split your contribution evenly across " + who + ".");

  return true;
}

function show_and_scroll(elem_id, kill_elem) {
  var elem = $('#' + elem_id);
  elem.fadeIn('fast', function() {
    smooth_scroll_to(elem);
    elem.find('.focus-on-shown').focus();
  })
  if (kill_elem)
    $(kill_elem).remove();
  return false; // for onclick events
}

function validate_contribution_amount(no_popover) {
  var valid = true;
  if (get_contribution_amount() == null) {
    $('#pledge-amount .input-group-addon').css({ color: '#666' })
    if (!no_popover)
      $('#pledge-amount').popover({ content: "Must be between ${{trigger.get_minimum_pledge}} and ${{alg.max_contrib|floatformat}}." }).popover('show');
    valid = false;
  } else {
    $('#pledge-amount .input-group-addon').css({ color: 'green' })
    $('#pledge-amount').popover('destroy');
  }
  return valid;
}

function contribution_start_validation(no_popover) {
  var valid =
       $('#pledge-info input[name="desired_outcome"]').val() != "?"
    && validate_contribution_amount(no_popover)
    && validate_contribution_filters(no_popover);
  $('#contribution-start-next').prop('disabled', !valid);
  return valid;
}

function computeTipAmount(pledge_amount) {
  // Compute a tip amount that is proportional to the
  // pledge amount. No need to let user choose this.
  return Math.round(pledge_amount/10*2) / 2 + .5;
}

function do_pledge_start_next() {
  if (!contribution_start_validation(true)) return;

  var amt = get_contribution_amount();

  {% if campaign.owner.de_recip_id %}
  // Set the tip-to-organization amount.
  var tip_amount = computeTipAmount(amt);
  $('#pledge-info input[name="tip_amount"]').val(tip_amount);
  $('#contribTipOrgAmt').text(tip_amount.toFixed(2));
  {% endif %}

  // Update controls.
  $('#pledge-amount input').prop('readonly', true);
  $('#pledge-start .buttons').hide();
  show_and_scroll('pledge-contributor');

  // Analytics.
  mixpanel.track("Pledge Amount Entered", { 'trigger': {{trigger.id}}, 'amount': amt });
}

var _did_pledge_show_email_popover = false;
function pledge_show_email_popover(text) {
  var e = $('#emailEmail');
  if (_did_pledge_show_email_popover) e.popover("destroy");
  if (text) {
    // something about having it be animated makes it sometimes prematurely disappear,
    // maybe because of combining it with our ajax loading indicator?
    e.popover({ content: text, placement: 'bottom', animation: false }).popover('show');
    _did_pledge_show_email_popover = true;
  } else {
    _did_pledge_show_email_popover = false;
  }
}

function do_pledge_login() {
  $('#login-error').fadeOut();

  if ($('#emailEmail').val() == "") {
    pledge_show_email_popover("Enter your email address.");
    return;
  }

  pledge_show_email_popover(); // clear

  // User wants to log in. An AJAX login will reset the CSRF token, so
  // we'll avoid actually logging the user in now and just do validation
  // and get defaults for the fields that follow.
  ajax_with_indicator({
    url: "/contrib/_defaults",
    method: "POST",
    data: {
      email: $('#emailEmail').val(),
      password: $('#emailPassword').val(),
      trigger: {{trigger.id}}
    },
    success: function(response) {
      // Error?
      if (response.status == "NotValid") {
        $('#login-error').text(response.message);
        $('#login-error').slideDown();
        return;
      }
      if (response.status == "AlreadyPledged") {
        $('#login-error').text("You have already scheduled a contribution for this {{trigger.trigger_type.strings.action_noun|escapejs}}. Please log in to see details.");
        $('#login-error').slideDown();
        return;
      }

      // Okay success. The user is logged in. The user may not have any pledges
      // in their account, but the "login" was successful. Hide the login form
      // fields --- they are no longer used.
      $('#emailEmail').prop('disabled', true);
      $('#pledge-login').slideUp();
      $('#contribNameFirst').focus();

      // Set contributor info from past records.
      setPledgeDefaults(response);
    }
  })
}

function do_pledge_validate_email(callback) {
  // User provides his email address and is a new user.

  // Start by validating it. Reject if the adddress is clearly
  // invalid. In the future we may want to issue a different
  // message for emails that are Valid but not Deliverable.
  // We also silently skip Error and let the user go forward.
  ajax_with_indicator({
    url: "/contrib/_validate_email",
    method: "POST",
    data: {
      trigger: {{trigger.id}},
      via_campaign: {{campaign.id}},
      desired_outcome: $('#pledge-info input[name="desired_outcome"]').val(),
      ref_code: '{{request.GET.utm_campaign|escapejs}}',
      email: $('#emailEmail').val()
    },
    indicator_delay: callback ? 100 : 1000, // when we're doing early validation, avoid the modal timer indicator
    success: function(response) {
      if (response != "OK") {
        pledge_show_email_popover(response);
        return;
      }

      // If it's valid, issue a warning if it's a likely misspelling
      // of a popular domain. We do this second because it is a warning
      // and not an error.
      $('#emailEmail').mailcheck({
        suggested: function(element, suggestion) {
          // warning
          pledge_show_email_popover("Are you sure you didn't mean " + suggestion.full + "?");
        },
        empty: function(element) {
          // no warning
          pledge_show_email_popover(); // clear
        }
      });

      // Either way, it was at most an informative warning, so go on.
      if (callback) callback();
    }
  })
}

function do_contributor_next() {
  if (!the_user)
    // validate the email address
    do_pledge_validate_email(do_contributor_next_);
  else
    // just go on - user isn't asked for an email address
    do_contributor_next_();
}

function do_contributor_next_() {
  // Validate contributor fields.

  var required_fields = ['contribNameFirst', 'contribNameLast', 'contribOccupation', 'contribEmployer', 'contribAddress', 'contribCity', 'contribState', 'contribZip'];
  var valid = true;

  for (var i = 0; i < required_fields.length; i++) {
    var elem = $('#' + required_fields[i]);
    elem.popover('destroy');
    if (!/\S/.test(elem.val())) {
      valid = false;
      elem.popover({ content: "Required." }).popover('show');
    }
  }

  if (!valid) return;

  $('#emailEmail').prop('readonly', true);
  $('#pledge-contributor input[type=text]').prop('readonly', true);
  $('#pledge-contributor input[type=checkbox]').prop('disabled', true);
  $('#pledge-contributor .buttons, #pledge-email-name-and-address-old-update, #pledge-contributor-old-update').hide();
  show_and_scroll('pledge-payment');

  mixpanel.track("Pledge Contributor Info Entered", { 'trigger': {{trigger.id}} });
}

function do_contributor_cancel() {
  $('#pledge-amount input').prop('readonly', false);
  $('#pledge-start .buttons').show();
  smooth_scroll_to($('#pledge-start'));
  $('#pledge-contributor').hide();
}

function validate_and_set_cc_fields() {
  $('#billingCCNum').popover('destroy');
  $('#billingCCExp').popover('destroy');
  $('#billingCCCVC').popover('destroy');

  if (!$.payment.validateCardNumber($('#billingCCNum').val())) {
    $('#billingCCNum').popover({ content: "Enter a credit card number." }).popover('show');
    return false;
  }

  var exp = $('#billingCCExp').payment('cardExpiryVal');
  if (!$.payment.validateCardExpiry(exp.month, exp.year)) {
    $('#billingCCExp').popover({ content: "Enter a valid expiration date." }).popover('show');
    return false;
  }
  $('#pledge-info input[name="billingCCExpMonth"]').val(exp.month);
  $('#pledge-info input[name="billingCCExpYear"]').val(exp.year);

  if (!$.payment.validateCardCVC($('#billingCCCVC').val())) {
    $('#billingCCCVC').popover({ content: "Enter your card verification code, often found on the back side of the card." }).popover('show');
    return false;
  }

  return true;
}

function pledge_submit() {
  // fill in some form fields
  $('#pledge-info input[name="amount"]').val(get_contribution_amount())
  $('#pledge-info input[name="incumb_challgr"]').val(getIncumbentChallengerValue())
  $('#pledge-info input[name="filter_party"]').val(getPartyFilterValue())

  // validate credit card information and set form fields, but only if we're not reusing an old pledge token
  if ($('#pledge-info input[name="copyFromPledge"]').val() == '')
    if (!validate_and_set_cc_fields())
      return;

  // Disable the payment fields prior to AJAX. (Use 'readonly' and not 'disabled' because serializeArray
  // skips disabled fields.)
  $('#billingCCNum, #billingCCExp, #billingCCCVC, #pledge-submit-buttons button').prop('readonly', true);

  // Valid. Submit! Collect all of the form fields.
  var form_params = $('#pledge-info').serializeArray();
  var data = { };
  for (var i = 0; i < form_params.length; i++)
    data[form_params[i].name] = form_params[i].value;

  ajax_with_indicator({
    url: '/contrib/_submit',
    method: "POST",
    data: data,
    success: function(res) {
      if (res.status == "ok") {
        // The pledge was saved. Update the page.
        var n = $('<div/>')
        n.html(res.html);
        $('#completed-pledge-holder').append(n);
        $('#make-pledge').slideUp(function() { show_and_scroll('completed-pledge-holder'); });
            // else: $('#pledge-submit-buttons').slideUp();

      } else if (res.status == "already-pledged") {
        show_modal_error("Error", "It looks like you have already pledged a contribution here. Please reload the page to see it.");
      } else if (res.status == "error" && res.message) {
        show_modal_error("Error", res.message);
        $('#billingCCNum, #billingCCExp, #billingCCCVC, #pledge-submit-buttons button').attr('disabled', false);
      } else {
        show_modal_error("Error", "Something went wrong, sorry.");
        $('#billingCCNum, #billingCCExp, #billingCCCVC, #pledge-submit-buttons button').attr('disabled', false);
        console.log(res);
      }
    }
  })

  // Conversion Tracking.

  // These might not execute if the AJAX request above is quick and
  // the reload begins before the mixpanel AJAX request is sent...

  // Mixpanel.
  mixpanel.track("Pledge Submitted", { 'trigger': {{trigger.id}} });

  // Facebook "Pledge Made" conversion.
  window._fbq.push(['track', '6023688411930', {'value': get_contribution_amount(), 'currency':'USD'}]);

  // Google AdWords Remarketing/Conversion. Value is the fees portion
  // of the expected transaction.
  goog_report_conversion(.04 * get_contribution_amount());
}

function pledge_payment_cancel() {
  $('#emailEmail').prop('readonly', false);
  $('#pledge-contributor input[type=text]').prop('readonly', false);
  $('#pledge-contributor input[type=checkbox]').prop('disabled', false);
  $('#pledge-contributor .buttons, #pledge-email-name-and-address-old-update, #pledge-contributor-old-update').show();
  $('#pledge-payment').hide();
}
</script>
